---
phase: 01-permissions-app-shell
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ScrollMyMac/ScrollMyMacApp.swift
  - ScrollMyMac/App/AppDelegate.swift
  - ScrollMyMac/App/AppState.swift
  - ScrollMyMac/Services/PermissionManager.swift
  - ScrollMyMac/Features/Settings/SettingsView.swift
  - ScrollMyMac/Features/Settings/PermissionSetupView.swift
  - ScrollMyMac.xcodeproj
autonomous: true

must_haves:
  truths:
    - "App launches as an unsandboxed macOS app with a visible main window"
    - "App detects whether Accessibility permission is granted"
    - "If permission is missing, app shows setup flow guiding user to System Settings"
    - "Closing the window does not quit the app -- app continues running with Dock icon"
    - "Clicking the Dock icon reopens the settings window"
    - "Permission grant is detected automatically without restart (1s polling)"
  artifacts:
    - path: "ScrollMyMac/ScrollMyMacApp.swift"
      provides: "@main App entry point with WindowGroup and NSApplicationDelegateAdaptor"
      contains: "@main"
    - path: "ScrollMyMac/App/AppDelegate.swift"
      provides: "Window lifecycle -- close hides, dock reopens, no quit on last window close"
      contains: "applicationShouldTerminateAfterLastWindowClosed"
    - path: "ScrollMyMac/App/AppState.swift"
      provides: "@Observable app state: scroll mode toggle, safety mode, permission state"
      contains: "isScrollModeActive"
    - path: "ScrollMyMac/Services/PermissionManager.swift"
      provides: "AXIsProcessTrusted polling and System Settings deep link"
      contains: "AXIsProcessTrusted"
    - path: "ScrollMyMac/Features/Settings/SettingsView.swift"
      provides: "Root view switching between permission setup and main settings"
      contains: "PermissionSetupView"
    - path: "ScrollMyMac/Features/Settings/PermissionSetupView.swift"
      provides: "First-launch permission guidance UI"
      contains: "Open System Settings"
  key_links:
    - from: "ScrollMyMac/ScrollMyMacApp.swift"
      to: "ScrollMyMac/App/AppDelegate.swift"
      via: "@NSApplicationDelegateAdaptor"
      pattern: "NSApplicationDelegateAdaptor"
    - from: "ScrollMyMac/Features/Settings/SettingsView.swift"
      to: "ScrollMyMac/Services/PermissionManager.swift"
      via: "Environment or State injection"
      pattern: "permissionManager"
    - from: "ScrollMyMac/Features/Settings/PermissionSetupView.swift"
      to: "ScrollMyMac/Services/PermissionManager.swift"
      via: "openAccessibilitySettings and startPolling calls"
      pattern: "openAccessibilitySettings"
---

<objective>
Create the Xcode project, app shell with correct window lifecycle, permission detection with polling, and the permission setup flow UI.

Purpose: Establish the foundational app that launches, stays running when the window is closed, detects Accessibility permission state, and guides the user through granting it.
Output: A buildable Xcode project with working app shell, permission detection, and onboarding UI.
</objective>

<execution_context>
@/Users/blakewatson/.claude/get-shit-done/workflows/execute-plan.md
@/Users/blakewatson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-permissions-app-shell/01-RESEARCH.md
@.planning/phases/01-permissions-app-shell/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Xcode project and app entry point with window lifecycle</name>
  <files>
    ScrollMyMac.xcodeproj
    ScrollMyMac/ScrollMyMacApp.swift
    ScrollMyMac/App/AppDelegate.swift
  </files>
  <action>
Create a new macOS SwiftUI Xcode project named "ScrollMyMac" using `swift package init` or by creating files directly. The project targets macOS 14+.

**ScrollMyMacApp.swift** -- the @main entry point:
- Use `@NSApplicationDelegateAdaptor(AppDelegate.self)` for window lifecycle control
- Use `WindowGroup` containing `SettingsView()` (placeholder for now -- will be created in Task 2)
- Pass `AppState` into the environment via `.environment(appState)`
- Remove "New Window" command: `.commands { CommandGroup(replacing: .newItem) { } }`
- Create `@State private var appState = AppState()`

**AppDelegate.swift** -- NSApplicationDelegate + NSWindowDelegate:
- `applicationShouldTerminateAfterLastWindowClosed` returns `false` (app keeps running when window closes)
- In `applicationDidFinishLaunching`, set `window.delegate = self` on the first window
- `windowShouldClose` calls `NSApp.hide(nil)` and returns `false` (hide instead of close, preserves window state)
- `applicationShouldHandleReopen` when `hasVisibleWindows` is false: call `NSApp.windows.first?.makeKeyAndOrderFront(nil)` and `NSApp.activate(ignoringOtherApps: true)`, return `true`
- Also implement `applicationWillBecomeActive` as fallback -- if no visible windows, show the first window (belt-and-suspenders for dock reopen reliability per research pitfall #3)

**Xcode project setup:**
- App Sandbox: OFF (accessibility apps cannot be sandboxed)
- Hardened Runtime: ON (for future notarization)
- Deployment target: macOS 14.0
- Bundle identifier: com.blakewatson.ScrollMyMac
- Add `NSAccessibilityUsageDescription` to Info.plist: "Scroll My Mac needs Accessibility access to intercept mouse clicks and convert them to scroll events system-wide."
- No external dependencies

If creating the project via `swift` CLI is impractical, create an Xcode project using the appropriate pbxproj structure or use `xcodebuild` commands. The simplest approach: create a Swift Package-based app or generate the .xcodeproj manually with the needed build settings. Use whichever method produces a buildable project most reliably.
  </action>
  <verify>
Run `xcodebuild -project ScrollMyMac.xcodeproj -scheme ScrollMyMac build` (or equivalent) and confirm it compiles without errors. If using Swift Package Manager, run `swift build`.
  </verify>
  <done>
Xcode project exists, compiles successfully, and contains the app entry point with WindowGroup and AppDelegate implementing close-hides-window and dock-reopens-window lifecycle.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement AppState, PermissionManager, and permission UI views</name>
  <files>
    ScrollMyMac/App/AppState.swift
    ScrollMyMac/Services/PermissionManager.swift
    ScrollMyMac/Features/Settings/SettingsView.swift
    ScrollMyMac/Features/Settings/PermissionSetupView.swift
  </files>
  <action>
**AppState.swift** -- @Observable centralized app state:
- `var isScrollModeActive: Bool = false` (toggle exists, not wired to functionality until Phase 2)
- `var isSafetyModeEnabled: Bool` backed by `UserDefaults` (key: "safetyModeEnabled", default: `true`)
- `var isAccessibilityGranted: Bool = false` (updated by PermissionManager)
- `var hasCompletedOnboarding: Bool` backed by `UserDefaults` (key: "hasCompletedOnboarding", default: `false`)
- Use `@ObservationIgnored` + manual `UserDefaults` access for persisted properties, or use `@AppStorage` in views that need them. Ensure safety mode and onboarding state survive app restart.

**PermissionManager.swift** -- accessibility permission detection:
- `import ApplicationServices` for `AXIsProcessTrusted()` and `AXIsProcessTrustedWithOptions()`
- `@Observable class PermissionManager`
- `var isAccessibilityGranted: Bool = false`
- `func checkPermission()` -- sets `isAccessibilityGranted = AXIsProcessTrusted()`
- `func requestPermission()` -- calls `AXIsProcessTrustedWithOptions` with `kAXTrustedCheckOptionPrompt: true` to trigger the system prompt (only call once during onboarding, not every launch)
- `func startPolling()` -- Timer at 1.0s interval, calls `checkPermission()`, stops polling when granted
- `func stopPolling()` -- invalidates timer
- `func openAccessibilitySettings()` -- opens `x-apple.systempreferences:com.apple.preference.security?Privacy_Accessibility` via `NSWorkspace.shared.open`. This is a fallback; the primary navigation is via `requestPermission()` which opens the system prompt automatically.
- Call `checkPermission()` in `init()`

**SettingsView.swift** -- root content view:
- Receives `AppState` from environment and creates/holds `PermissionManager` as `@State`
- On appear: sync `permissionManager.isAccessibilityGranted` to `appState.isAccessibilityGranted`
- Conditional display: if `appState.isAccessibilityGranted` OR `appState.hasCompletedOnboarding` show `MainSettingsView` (to be created in Plan 02), else show `PermissionSetupView`
- For now, if permission is granted, show a simple placeholder with text "Settings" and the scroll mode toggle -- Plan 02 will flesh this out into the full settings form
- When permission transitions from false to true, set `appState.hasCompletedOnboarding = true`

**PermissionSetupView.swift** -- first-launch permission guidance:
- Takes `PermissionManager` as parameter (or from environment)
- Shows: icon (SF Symbol `hand.raised.circle` at 48pt), title "Accessibility Permission Required", explanatory text about why the permission is needed
- Numbered steps: 1) Open System Settings, 2) Go to Privacy & Security > Accessibility, 3) Enable Scroll My Mac
- "Grant Permission" button that calls `permissionManager.requestPermission()` then `permissionManager.startPolling()`
- Secondary "Open System Settings" button/link that calls `permissionManager.openAccessibilitySettings()` then `permissionManager.startPolling()`
- Caption text: "The app will detect permission automatically -- no restart needed."
- Frame: `minWidth: 400, minHeight: 350`
- On disappear: `permissionManager.stopPolling()` (stop polling when view is no longer shown)
  </action>
  <verify>
Build the project and confirm it compiles. Launch the app -- it should show the PermissionSetupView if Accessibility permission is not granted, or the placeholder settings view if it is. Verify that clicking "Grant Permission" triggers the macOS system accessibility prompt. Verify that the app detects permission grant within a few seconds (no manual restart needed).
  </verify>
  <done>
AppState holds all Phase 1 state with persistence for safety mode and onboarding. PermissionManager detects and polls for Accessibility permission. SettingsView switches between permission setup and settings based on permission state. PermissionSetupView guides user through granting permission with clear instructions and automatic detection.
  </done>
</task>

</tasks>

<verification>
1. `xcodebuild build` (or `swift build`) succeeds with no errors
2. App launches and shows PermissionSetupView when Accessibility permission is not granted
3. Clicking "Grant Permission" triggers the macOS system accessibility prompt
4. After granting permission in System Settings, the app detects it within ~2 seconds and transitions to the settings view
5. Closing the window (Cmd+W or close button) hides the window but keeps the app running in the Dock
6. Clicking the Dock icon after closing reopens the settings window
7. Cmd+N does not create a second window
8. Relaunching the app after onboarding goes directly to settings (not the permission setup flow)
</verification>

<success_criteria>
- Buildable macOS app targeting macOS 14+, unsandboxed with hardened runtime
- Window lifecycle: close hides, dock click reopens, no quit on last window close
- Accessibility permission detection via AXIsProcessTrusted with 1s polling
- Permission setup flow with clear guidance and automatic grant detection
- Persistent onboarding state (shows settings on subsequent launches)
- AppState with scroll mode toggle, safety mode toggle, and permission state
</success_criteria>

<output>
After completion, create `.planning/phases/01-permissions-app-shell/01-01-SUMMARY.md`
</output>
