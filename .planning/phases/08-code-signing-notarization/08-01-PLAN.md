---
phase: 08-code-signing-notarization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ScrollMyMac.xcodeproj/project.pbxproj
  - scripts/build-release.sh
autonomous: false
requirements:
  - SIGN-01
  - SIGN-02
  - SIGN-03
user_setup:
  - service: apple-developer
    why: "Code signing and notarization require an active Apple Developer Program membership and a Developer ID Application certificate"
    env_vars: []
    dashboard_config:
      - task: "Enroll in Apple Developer Program (if not already)"
        location: "https://developer.apple.com/programs/enroll/"
      - task: "Create a Developer ID Application certificate via Xcode (Xcode > Settings > Accounts > Manage Certificates > + > Developer ID Application) or via Apple Developer portal"
        location: "Xcode Settings > Accounts, or https://developer.apple.com/account/resources/certificates"
      - task: "Create an app-specific password for notarization (if using Apple ID auth) at appleid.apple.com > Sign-In and Security > App-Specific Passwords"
        location: "https://appleid.apple.com/account/manage"

must_haves:
  truths:
    - "App binary is signed with Developer ID Application certificate"
    - "App has a stapled notarization ticket from Apple"
    - "App opens on any Mac without Gatekeeper warnings"
  artifacts:
    - path: "scripts/build-release.sh"
      provides: "Reproducible release build, sign, notarize, and staple script"
  key_links:
    - from: "scripts/build-release.sh"
      to: "codesign + xcrun notarytool + xcrun stapler"
      via: "CLI commands in build script"
      pattern: "codesign.*Developer ID"
---

<objective>
Sign and notarize the Scroll My Mac app so it opens on any Mac without Gatekeeper warnings.

Purpose: Without code signing and notarization, macOS Gatekeeper blocks the app with an "unidentified developer" dialog, preventing easy distribution. This plan creates a reproducible build-sign-notarize pipeline.

Output: A `scripts/build-release.sh` script that builds a release archive, signs it with a Developer ID Application certificate, submits it to Apple for notarization, and staples the ticket. The Xcode project is updated for manual signing with the user's team ID.
</objective>

<execution_context>
@/Users/blakewatson/.claude/get-shit-done/workflows/execute-plan.md
@/Users/blakewatson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@ScrollMyMac.xcodeproj/project.pbxproj
@ScrollMyMac/ScrollMyMac.entitlements
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Ensure Developer ID certificate is installed</name>
  <action>
    The user must have a Developer ID Application certificate installed in their keychain. This is required for all subsequent steps.

    Verify by running:
    ```
    security find-identity -v -p codesigning | grep "Developer ID Application"
    ```

    If no result appears, the user needs to:
    1. Open Xcode > Settings > Accounts
    2. Sign in with their Apple Developer account
    3. Click "Manage Certificates"
    4. Click "+" and select "Developer ID Application"
    5. Wait for the certificate to be created and downloaded

    Alternatively, create the certificate at https://developer.apple.com/account/resources/certificates and install it.

    The user should also note their Team ID (visible in Xcode > Settings > Accounts, or at https://developer.apple.com/account under Membership Details).
  </action>
  <verify>Run `security find-identity -v -p codesigning | grep "Developer ID Application"` and confirm at least one identity appears.</verify>
  <done>A "Developer ID Application" certificate is installed and visible in keychain.</done>
  <resume-signal>Paste the output of `security find-identity -v -p codesigning | grep "Developer ID Application"` and provide your Team ID.</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Create release build-sign-notarize script and update Xcode project</name>
  <files>
    scripts/build-release.sh
    ScrollMyMac.xcodeproj/project.pbxproj
  </files>
  <action>
    **Step A: Update Xcode project for manual signing.**

    In `project.pbxproj`, update both Debug and Release build configurations:
    - Set `CODE_SIGN_STYLE = Manual;`
    - Set `DEVELOPMENT_TEAM` to the user's Team ID (from Task 1)
    - Set `CODE_SIGN_IDENTITY = "Developer ID Application";`

    Also add the hardened runtime entitlement. In the entitlements file (`ScrollMyMac/ScrollMyMac.entitlements`), the existing `com.apple.security.app-sandbox = false` is correct for this unsandboxed app. No changes needed to entitlements.

    **Step B: Create `scripts/build-release.sh`.**

    Create a shell script that performs the full release pipeline:

    ```bash
    #!/bin/bash
    set -euo pipefail

    # Configuration
    APP_NAME="ScrollMyMac"
    SCHEME="ScrollMyMac"
    BUILD_DIR="build/release"
    ARCHIVE_PATH="$BUILD_DIR/$APP_NAME.xcarchive"
    EXPORT_PATH="$BUILD_DIR/export"
    APP_PATH="$EXPORT_PATH/$APP_NAME.app"
    ZIP_PATH="$BUILD_DIR/$APP_NAME.zip"

    # Signing identity -- auto-detect from keychain
    SIGNING_IDENTITY=$(security find-identity -v -p codesigning | grep "Developer ID Application" | head -1 | sed 's/.*"\(.*\)"/\1/')

    if [ -z "$SIGNING_IDENTITY" ]; then
      echo "ERROR: No Developer ID Application certificate found in keychain."
      echo "Install one via Xcode > Settings > Accounts > Manage Certificates."
      exit 1
    fi

    echo "Using signing identity: $SIGNING_IDENTITY"

    # Clean build directory
    rm -rf "$BUILD_DIR"
    mkdir -p "$BUILD_DIR"

    # Step 1: Archive
    echo "==> Archiving..."
    xcodebuild archive \
      -project "$APP_NAME.xcodeproj" \
      -scheme "$SCHEME" \
      -configuration Release \
      -archivePath "$ARCHIVE_PATH" \
      CODE_SIGN_STYLE=Manual \
      CODE_SIGN_IDENTITY="$SIGNING_IDENTITY" \
      OTHER_CODE_SIGN_FLAGS="--options=runtime" \
      ENABLE_HARDENED_RUNTIME=YES \
      | tail -5

    # Step 2: Export from archive
    echo "==> Exporting..."
    mkdir -p "$EXPORT_PATH"
    cp -R "$ARCHIVE_PATH/Products/Applications/$APP_NAME.app" "$APP_PATH"

    # Step 3: Re-sign with hardened runtime (belt and suspenders)
    echo "==> Signing with hardened runtime..."
    codesign --force --deep --options runtime \
      --sign "$SIGNING_IDENTITY" \
      --entitlements "$APP_NAME/$APP_NAME.entitlements" \
      "$APP_PATH"

    # Step 4: Verify signature
    echo "==> Verifying signature..."
    codesign -v --verbose=2 "$APP_PATH"
    codesign -d --verbose=2 "$APP_PATH" 2>&1 | grep "Authority"

    # Step 5: Create zip for notarization
    echo "==> Creating zip for notarization..."
    ditto -c -k --keepParent "$APP_PATH" "$ZIP_PATH"

    # Step 6: Submit for notarization
    echo "==> Submitting for notarization..."
    echo "You will be prompted for your Apple ID credentials if not using --keychain-profile."
    echo ""
    echo "To store credentials (one-time setup):"
    echo "  xcrun notarytool store-credentials \"ScrollMyMac\" --apple-id YOUR_APPLE_ID --team-id YOUR_TEAM_ID"
    echo ""

    if xcrun notarytool store-credentials --help >/dev/null 2>&1; then
      # Try keychain profile first, fall back to interactive
      if xcrun notarytool submit "$ZIP_PATH" --keychain-profile "ScrollMyMac" --wait 2>/dev/null; then
        echo "==> Notarization complete (keychain profile)."
      else
        echo "No stored keychain profile found. Using interactive mode..."
        xcrun notarytool submit "$ZIP_PATH" --wait \
          --apple-id "${APPLE_ID:-}" \
          --team-id "${TEAM_ID:-}" \
          --password "${APP_SPECIFIC_PASSWORD:-}"
      fi
    fi

    # Step 7: Staple the ticket
    echo "==> Stapling notarization ticket..."
    xcrun stapler staple "$APP_PATH"

    # Step 8: Verify staple
    echo "==> Verifying stapled ticket..."
    xcrun stapler validate "$APP_PATH"

    # Step 9: Re-zip with stapled app for distribution
    echo "==> Creating final distribution zip..."
    rm -f "$ZIP_PATH"
    ditto -c -k --keepParent "$APP_PATH" "$ZIP_PATH"

    echo ""
    echo "==> DONE!"
    echo "Signed and notarized app: $APP_PATH"
    echo "Distribution zip: $ZIP_PATH"
    echo ""
    echo "Verify Gatekeeper acceptance:"
    echo "  spctl --assess --verbose=4 --type execute \"$APP_PATH\""
    ```

    Make the script executable with `chmod +x scripts/build-release.sh`.
  </action>
  <verify>
    1. `cat scripts/build-release.sh` exists and is executable (`ls -la scripts/build-release.sh` shows +x)
    2. `grep "CODE_SIGN_STYLE = Manual" ScrollMyMac.xcodeproj/project.pbxproj` returns matches
    3. `grep "Developer ID Application" ScrollMyMac.xcodeproj/project.pbxproj` returns matches
    4. Run `bash -n scripts/build-release.sh` to syntax-check the script (should exit 0)
  </verify>
  <done>
    - Xcode project configured for manual signing with Developer ID Application
    - `scripts/build-release.sh` exists, is executable, and passes syntax check
    - Script handles: archive, sign with hardened runtime, notarize, staple, verify, zip
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Run build-release script and verify Gatekeeper acceptance</name>
  <files>build/release/export/ScrollMyMac.app</files>
  <action>
    User runs the build-release script and verifies the output. Claude has already created the script and configured the Xcode project -- this task confirms the pipeline works end-to-end.

    Steps for user:
    1. If not done already, store notarization credentials:
       `xcrun notarytool store-credentials "ScrollMyMac" --apple-id YOUR_APPLE_ID --team-id YOUR_TEAM_ID`
       (You will be prompted for an app-specific password)
    2. Run: `cd /Users/blakewatson/Dropbox/Projects/scroll-my-mac && ./scripts/build-release.sh`
    3. Wait for notarization (usually 1-5 minutes)
    4. After completion, verify:
       - `codesign -v build/release/export/ScrollMyMac.app` (should print nothing, exit 0)
       - `xcrun stapler validate build/release/export/ScrollMyMac.app` (should say "The validate action worked!")
       - `spctl --assess --verbose=4 --type execute build/release/export/ScrollMyMac.app` (should say "accepted" with "source=Notarized Developer ID")
    5. Optional: Copy `build/release/ScrollMyMac.zip` to another Mac, extract, and double-click to confirm no Gatekeeper warning appears
  </action>
  <verify>`spctl --assess --verbose=4 --type execute build/release/export/ScrollMyMac.app` reports "accepted" with source=Notarized Developer ID</verify>
  <done>App binary is signed, notarized, stapled, and passes Gatekeeper assessment without warnings.</done>
</task>

</tasks>

<verification>
1. `security find-identity -v -p codesigning | grep "Developer ID Application"` shows a valid identity
2. `codesign -v build/release/export/ScrollMyMac.app` exits 0 (valid signature)
3. `xcrun stapler validate build/release/export/ScrollMyMac.app` reports success
4. `spctl --assess --verbose=4 --type execute build/release/export/ScrollMyMac.app` reports "accepted" with "Notarized Developer ID"
</verification>

<success_criteria>
- App is signed with Developer ID Application certificate (SIGN-01)
- App has a stapled notarization ticket from Apple (SIGN-02)
- App opens without Gatekeeper warnings (SIGN-03)
- Reproducible build script exists for future releases
</success_criteria>

<output>
After completion, create `.planning/phases/08-code-signing-notarization/08-01-SUMMARY.md`
</output>
