---
phase: 10-menu-bar-icon
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ScrollMyMac/Services/MenuBarManager.swift
  - ScrollMyMac/Resources/Assets.xcassets/MenuBarIcon.imageset/Contents.json
  - ScrollMyMac/Resources/Assets.xcassets/MenuBarIcon.imageset/menu-bar-icon.pdf
  - ScrollMyMac/App/AppState.swift
  - ScrollMyMac/Features/Settings/SettingsView.swift
  - ScrollMyMac/ScrollMyMacApp.swift
  - ScrollMyMac.xcodeproj/project.pbxproj
autonomous: true
requirements:
  - MBAR-01
  - MBAR-02
  - MBAR-03
  - MBAR-04

must_haves:
  truths:
    - "A menu bar icon is visible when enabled, showing a mouse icon"
    - "The icon opacity changes to reflect scroll mode on (full) vs off (semi-transparent)"
    - "Left-clicking the menu bar icon toggles scroll mode on/off"
    - "Right-clicking the menu bar icon shows a context menu with Settings... and Quit Scroll My Mac"
    - "Settings... menu item opens the settings window and brings the app to front"
    - "Quit menu item terminates the app"
    - "User can disable the menu bar icon in settings and it disappears"
    - "User can re-enable the menu bar icon in settings and it reappears without restart"
  artifacts:
    - path: "ScrollMyMac/Services/MenuBarManager.swift"
      provides: "NSStatusItem management with left-click toggle and right-click context menu"
      min_lines: 40
    - path: "ScrollMyMac/Resources/Assets.xcassets/MenuBarIcon.imageset/Contents.json"
      provides: "Asset catalog entry for template image"
    - path: "ScrollMyMac/App/AppState.swift"
      provides: "isMenuBarIconEnabled setting with MenuBarManager wiring"
    - path: "ScrollMyMac/Features/Settings/SettingsView.swift"
      provides: "Toggle for menu bar icon visibility in General section"
  key_links:
    - from: "ScrollMyMac/Services/MenuBarManager.swift"
      to: "AppState.toggleScrollMode()"
      via: "onToggle callback"
      pattern: "onToggle"
    - from: "ScrollMyMac/Services/MenuBarManager.swift"
      to: "AppState.isScrollModeActive"
      via: "updateIcon(isActive:) call"
      pattern: "updateIcon"
    - from: "ScrollMyMac/App/AppState.swift"
      to: "MenuBarManager"
      via: "show/hide and state updates"
      pattern: "menuBarManager"
---

<objective>
Add a menu bar status item that shows scroll mode state (on/off) via a custom mouse icon with opacity changes, provides left-click toggle and right-click context menu, and can be disabled in settings.

Purpose: Give users a persistent visual indicator and quick toggle without needing the hotkey or settings window.
Output: Working menu bar icon with toggle, context menu, and settings integration.
</objective>

<execution_context>
@/Users/blakewatson/.claude/get-shit-done/workflows/execute-plan.md
@/Users/blakewatson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@ScrollMyMac/App/AppState.swift
@ScrollMyMac/Features/Settings/SettingsView.swift
@ScrollMyMac/ScrollMyMacApp.swift
@ScrollMyMac/App/AppDelegate.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MenuBarManager service with custom icon and wire into AppState</name>
  <files>
    ScrollMyMac/Services/MenuBarManager.swift
    ScrollMyMac/Resources/Assets.xcassets/MenuBarIcon.imageset/Contents.json
    ScrollMyMac/App/AppState.swift
    ScrollMyMac.xcodeproj/project.pbxproj
  </files>
  <action>
    Create `MenuBarManager.swift` in Services/:

    **MenuBarManager class** (not @Observable — pure AppKit, no SwiftUI observation needed):
    - Properties:
      - `private var statusItem: NSStatusItem?`
      - `var onToggle: (() -> Void)?` — callback for left-click toggle
      - `var onOpenSettings: (() -> Void)?` — callback for Settings... menu item
    - `show()` method:
      - Creates `NSStatusBar.system.statusItem(withLength: .squareLength)`
      - Sets button image from a template NSImage (see icon details below)
      - Sets `button.image?.isTemplate = true` so macOS handles light/dark
      - Sets button target/action to a `handleClick` method
      - Sets `button.sendAction(on: [.leftMouseUp, .rightMouseUp])` to distinguish left vs right click
      - Stores in `statusItem`
    - `hide()` method:
      - Calls `NSStatusBar.system.removeStatusItem(statusItem!)` and sets `statusItem = nil`
    - `updateIcon(isActive: Bool)` method:
      - Sets `button.alphaValue = isActive ? 1.0 : 0.4` for full opacity vs semi-transparent
    - `handleClick()` method (the button's action):
      - Check `NSApp.currentEvent?.type`:
        - If `.rightMouseUp`: show context menu via `statusItem?.menu = menu; statusItem?.button?.performClick(nil); statusItem?.menu = nil` pattern, OR use `popUpMenu()` approach. Best approach: build NSMenu, call `menu.popUp(positioning: nil, at: NSPoint(x: 0, y: statusItem!.button!.bounds.height), in: statusItem!.button!)`
        - If `.leftMouseUp`: call `onToggle?()`
    - Private `buildContextMenu() -> NSMenu` method:
      - "Settings..." item → calls `onOpenSettings?()` callback
      - Separator
      - "Quit Scroll My Mac" item → calls `NSApp.terminate(nil)`

    **Important implementation note for right-click menu:** The simplest reliable approach for distinguishing left/right click on NSStatusItem:
    - Set `button.sendAction(on: [.leftMouseUp, .rightMouseUp])`
    - In the action handler, check `NSApp.currentEvent?.type`
    - For right-click, use `statusItem?.menu = buildContextMenu()` then `statusItem?.button?.performClick(nil)` then immediately set `statusItem?.menu = nil`. OR simpler: just call `buildContextMenu().popUp(positioning: nil, at: .zero, in: statusItem!.button!)`

    **Custom icon — programmatic NSImage (no PDF asset needed):**
    Instead of creating a PDF asset, draw the mouse icon programmatically using NSBezierPath. This avoids asset catalog complexity and keeps it code-only.

    Create a private method `makeMenuBarIcon() -> NSImage`:
    - Create an NSImage of size 18x18 (standard menu bar icon size)
    - Use `image.lockFocus()` / `image.unlockFocus()` pattern
    - Draw a simple mouse outline:
      - Rounded rectangle body (roughly 8x13, centered, with rounded top corners more pronounced)
      - Vertical line down the middle top third (scroll wheel divider)
      - Small circle or oval near the top center (scroll wheel)
    - Use `NSColor.black` for strokes (template image will be auto-colored by macOS)
    - Set `image.isTemplate = true`
    - Line width: 1.0-1.5pt for menu bar readability

    Remove the asset catalog imageset approach from files_modified — we will NOT create MenuBarIcon.imageset since the icon is drawn in code.

    **AppState changes:**
    - Add `var isMenuBarIconEnabled: Bool` property with UserDefaults persistence (key: "menuBarIconEnabled", default: `true`)
    - Add `let menuBarManager = MenuBarManager()` alongside other services
    - In `setupServices()`:
      - Set `menuBarManager.onToggle = { [weak self] in self?.toggleScrollMode() }`
      - Set `menuBarManager.onOpenSettings = { ... }` — this should call `NSApp.windows.first?.makeKeyAndOrderFront(nil); NSApp.activate(ignoringOtherApps: true)` to show settings window
      - If `isMenuBarIconEnabled`, call `menuBarManager.show()` then `menuBarManager.updateIcon(isActive: isScrollModeActive)`
    - In `isScrollModeActive` didSet, add: `menuBarManager.updateIcon(isActive: isScrollModeActive)`
    - In `isMenuBarIconEnabled` didSet:
      - Persist to UserDefaults
      - If enabled: `menuBarManager.show(); menuBarManager.updateIcon(isActive: isScrollModeActive)`
      - If disabled: `menuBarManager.hide()`
    - In `resetToDefaults()`, add: `isMenuBarIconEnabled = true`

    **pbxproj update:**
    Add MenuBarManager.swift to the Xcode project's file references and build sources. Follow the same pattern used for other Service files (look at how WindowExclusionManager.swift is referenced).
  </action>
  <verify>
    Build the project with `xcodebuild -project ScrollMyMac.xcodeproj -scheme ScrollMyMac build 2>&1 | tail -5` — must compile without errors.
  </verify>
  <done>
    MenuBarManager service exists, AppState creates and wires it, icon appears in menu bar on launch (enabled by default), left-click toggles scroll mode, right-click shows context menu with Settings... and Quit, icon opacity reflects scroll mode state, project builds cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add menu bar icon toggle to settings UI</name>
  <files>
    ScrollMyMac/Features/Settings/SettingsView.swift
  </files>
  <action>
    In `MainSettingsView`, add a toggle for the menu bar icon in the "General" section (before the "Launch at login" toggle):

    ```swift
    Toggle("Show menu bar icon", isOn: $appState.isMenuBarIconEnabled)
    Text("Display a status icon in the menu bar for quick scroll mode toggling.")
        .font(.caption)
        .foregroundStyle(.secondary)
    ```

    This binds directly to `appState.isMenuBarIconEnabled` which handles show/hide via its didSet. No additional wiring needed in the view.
  </action>
  <verify>
    Build succeeds. Read SettingsView.swift and confirm the toggle is present in the General section with descriptive help text.
  </verify>
  <done>
    Settings UI contains a "Show menu bar icon" toggle in the General section. Toggling it off hides the menu bar icon; toggling it on shows it. The setting persists across app restarts.
  </done>
</task>

</tasks>

<verification>
1. `xcodebuild -project ScrollMyMac.xcodeproj -scheme ScrollMyMac build` succeeds
2. MenuBarManager.swift exists in Services/ with show/hide/updateIcon/handleClick methods
3. AppState.swift has isMenuBarIconEnabled property with UserDefaults persistence
4. AppState.swift wires menuBarManager.onToggle and onOpenSettings callbacks
5. AppState.isScrollModeActive didSet calls menuBarManager.updateIcon
6. SettingsView.swift has "Show menu bar icon" toggle in General section
7. Context menu has "Settings..." and "Quit Scroll My Mac" items
</verification>

<success_criteria>
- Menu bar icon visible on app launch (enabled by default)
- Icon changes opacity when scroll mode toggles
- Left-click on icon toggles scroll mode
- Right-click on icon shows context menu
- "Settings..." opens the app window
- "Quit Scroll My Mac" terminates the app
- Toggle in settings hides/shows the menu bar icon
- Setting persists across restarts
</success_criteria>

<output>
After completion, create `.planning/phases/10-menu-bar-icon/10-01-SUMMARY.md`
</output>
