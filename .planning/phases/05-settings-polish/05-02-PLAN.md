---
phase: 05-settings-polish
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - ScrollMyMac/Features/Settings/SettingsView.swift
  - ScrollMyMac/App/AppDelegate.swift
  - ScrollMyMac/App/AppState.swift
autonomous: false

must_haves:
  truths:
    - "User can toggle launch at login in settings and it persists via SMAppService"
    - "Settings view consolidates all settings: hotkey recorder, launch at login, click-through, safety timeout"
    - "Reset to defaults button restores F6 hotkey, safety on, click-through on (does not reset launch at login)"
    - "App launches silently in background when started as a login item (no window shown)"
    - "Clicking the dock icon reopens the window after silent login launch"
    - "Current hotkey is displayed with proper modifier symbols in the settings UI"
    - "When hotkey is cleared (None), the help text updates to indicate UI-only control"
  artifacts:
    - path: "ScrollMyMac/Features/Settings/SettingsView.swift"
      provides: "Consolidated settings with hotkey recorder, launch at login, reset to defaults"
    - path: "ScrollMyMac/App/AppDelegate.swift"
      provides: "Silent background launch on login item start"
    - path: "ScrollMyMac/App/AppState.swift"
      provides: "resetToDefaults() method"
  key_links:
    - from: "SettingsView launch at login toggle"
      to: "SMAppService.mainApp.register/unregister"
      via: "onChange handler"
    - from: "AppDelegate.applicationDidFinishLaunching"
      to: "getppid() == 1 check"
      via: "Silent launch detection"
    - from: "SettingsView reset button"
      to: "AppState.resetToDefaults()"
      via: "Button action"
---

<objective>
Consolidate all settings into a unified view, add launch at login, implement silent background launch, and add reset to defaults.

Purpose: Users need a single organized settings view with all options, the ability to auto-launch at login (starting silently), and a way to reset everything to defaults.

Output: Unified SettingsView with all sections, SMAppService launch-at-login toggle, silent login launch in AppDelegate, reset-to-defaults in AppState.
</objective>

<execution_context>
@/Users/blakewatson/.claude/get-shit-done/workflows/execute-plan.md
@/Users/blakewatson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-settings-polish/05-RESEARCH.md
@.planning/phases/05-settings-polish/05-01-SUMMARY.md
@ScrollMyMac/Features/Settings/SettingsView.swift
@ScrollMyMac/App/AppDelegate.swift
@ScrollMyMac/App/AppState.swift
@ScrollMyMac/Features/Settings/HotkeyRecorderView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unified settings view with hotkey recorder, launch at login, and reset to defaults</name>
  <files>
    ScrollMyMac/Features/Settings/SettingsView.swift
    ScrollMyMac/App/AppState.swift
    ScrollMyMac/App/AppDelegate.swift
  </files>
  <action>
**SettingsView.swift** — Rebuild `MainSettingsView` to consolidate ALL settings into organized sections:

1. **Permission warning section** (keep existing — shown when accessibility permission revoked)

2. **Scroll Mode section:**
   - Toggle "Enable Scroll Mode" (existing)
   - Toggle "Click-through" (existing)
   - Help text for scroll mode (update to show current hotkey name dynamically, e.g. "Press F6 or use this toggle..." becomes "Press {hotkeyDisplayString} or use this toggle..." — or "Use this toggle to activate scroll mode." when no hotkey set)

3. **Hotkey section:**
   - Label "Hotkey" with `HotkeyRecorderView` bound to `appState.hotkeyKeyCode` and `appState.hotkeyModifiers`
   - Help text: "Click the field and press a key to set your hotkey. Function keys work alone; other keys need a modifier (Cmd, Ctrl, Option, Shift)."

4. **Safety section:**
   - Toggle "Safety timeout" (existing)
   - Help text (existing)

5. **General section:**
   - Launch at login toggle using `@State private var launchAtLogin: Bool`:
     - On `onAppear`, set `launchAtLogin = SMAppService.mainApp.status == .enabled`
     - On `onChange(of: launchAtLogin)`, call `try SMAppService.mainApp.register()` or `try SMAppService.mainApp.unregister()`. On error, revert the toggle state and print the error.
   - Help text: "Start Scroll My Mac automatically when you log in. The app launches in the background."
   - Import `ServiceManagement` at the top of the file.

6. **Reset section** (at the bottom):
   - Button "Reset to Defaults" that calls `appState.resetToDefaults()`.
   - Use `.foregroundColor(.red)` or destructive button style.
   - No confirmation dialog needed (per Claude's discretion — reset is non-destructive since user can always re-configure, and launch at login is intentionally excluded from reset).

**AppState.swift** — Add `resetToDefaults()` method:
```swift
func resetToDefaults() {
    hotkeyKeyCode = Int(kVK_F6)
    hotkeyModifiers = 0
    isSafetyModeEnabled = true
    isClickThroughEnabled = true
    // Launch at login intentionally NOT reset (system-level setting)
}
```

**AppDelegate.swift** — Add silent background launch:
- Import `ServiceManagement` at the top.
- In `applicationDidFinishLaunching`, after the existing window delegate setup, add:
```swift
// If launched by launchd as a login item, hide window
if getppid() == 1 && SMAppService.mainApp.status == .enabled {
    NSApp.windows.first?.orderOut(nil)
}
```
- The existing `applicationShouldHandleReopen` already handles dock-click-to-reopen, so no changes needed there.

Remove the `applicationWillBecomeActive` belt-and-suspenders code that force-shows windows on every activation, since it would conflict with silent login launch (it would immediately show the window we just hid). The `applicationShouldHandleReopen` handler is sufficient for dock-click-to-reopen.
  </action>
  <verify>
Build the project with `xcodebuild -project ScrollMyMac.xcodeproj -scheme ScrollMyMac build`. All files compile with ServiceManagement import. Verify the settings view has all sections present.
  </verify>
  <done>
Unified settings view with hotkey recorder, launch at login, click-through, safety timeout, and reset to defaults. Silent background launch on login. All settings consolidated in one view.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Full settings and launch behavior verification</name>
  <action>
Human verification of consolidated settings and launch behavior per checkpoint protocol.
  </action>
  <verify>
User confirms all settings work correctly per the verification checklist below.
  </verify>
  <done>
All Phase 5 features verified: hotkey customization, launch at login, settings consolidation, reset to defaults, silent background launch.
  </done>
  <what-built>
Complete Phase 5 settings and polish:
- Hotkey recorder UI with key capture and validation
- Launch at login toggle via SMAppService
- Silent background launch when started as login item
- All settings consolidated in one unified view
- Reset to defaults button
  </what-built>
  <how-to-verify>
1. **Build and run** the app from Xcode.
2. **Hotkey recorder:**
   - Find the Hotkey section in settings.
   - Click the hotkey field — it should show "Press a key..."
   - Press F6 — it should capture "F6".
   - Click again, press Cmd+Shift+S — should capture and display the modifier symbols + S.
   - Click again, press a bare letter key (e.g., just "A") — should be silently ignored (keep recording).
   - Press Escape — should cancel recording and revert to previous hotkey.
   - Click "Clear" — hotkey should show "None".
   - With hotkey cleared, verify the help text updates to indicate UI-only control.
   - Set a new hotkey, verify it works to toggle scroll mode.
3. **Launch at login:**
   - Toggle "Launch at login" ON in settings.
   - Open System Settings > General > Login Items — verify the app appears.
   - Toggle OFF — verify it disappears from Login Items.
4. **Settings layout:**
   - All settings visible in one view: scroll mode toggle, click-through, hotkey, safety timeout, launch at login, reset to defaults.
5. **Reset to defaults:**
   - Change hotkey to something other than F6, disable safety timeout.
   - Click "Reset to Defaults".
   - Verify hotkey resets to F6, safety timeout re-enables, click-through re-enables.
   - Verify launch at login is NOT affected by reset.
6. **Persistence:**
   - Change some settings, quit and relaunch the app — settings should persist.
7. **Silent launch (optional — requires logout/login):**
   - Enable launch at login, log out and back in.
   - App should NOT show a window on login.
   - Click dock icon — window should appear.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. Project builds: `xcodebuild -project ScrollMyMac.xcodeproj -scheme ScrollMyMac build`
2. All settings visible in one unified view
3. Hotkey recorder captures keys and validates correctly
4. Launch at login registers/unregisters with SMAppService
5. AppDelegate hides window on login launch (getppid() == 1)
6. Reset to defaults restores F6, safety on, click-through on
7. Settings persist across app restart
</verification>

<success_criteria>
- All settings consolidated in one unified settings view
- Launch at login works via SMAppService (toggle in settings, reflects in System Settings)
- Silent background launch when started as login item
- Reset to defaults restores all app preferences except launch at login
- User verifies all behavior in checkpoint
</success_criteria>

<output>
After completion, create `.planning/phases/05-settings-polish/05-02-SUMMARY.md`
</output>
