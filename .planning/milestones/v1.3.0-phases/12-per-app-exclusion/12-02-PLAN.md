---
phase: 12-per-app-exclusion
plan: 02
type: execute
wave: 2
depends_on:
  - 12-01
files_modified:
  - ScrollMyMac/Features/Settings/SettingsView.swift
autonomous: false
requirements:
  - EXCL-03

must_haves:
  truths:
    - "User can add an app to the exclusion list via a + button that opens a file picker filtered to .app bundles"
    - "User can remove an app from the exclusion list via a – button"
    - "Exclusion list displays each app with its icon and display name"
    - "Empty exclusion list shows 'No excluded apps' placeholder"
    - "Adding a duplicate app is silently ignored"
  artifacts:
    - path: "ScrollMyMac/Features/Settings/SettingsView.swift"
      provides: "Exclusion list UI section with add/remove functionality"
      contains: "Excluded Apps"
  key_links:
    - from: "ScrollMyMac/Features/Settings/SettingsView.swift"
      to: "ScrollMyMac/App/AppState.swift"
      via: "addExcludedApp and removeExcludedApp calls"
      pattern: "addExcludedApp|removeExcludedApp"
---

<objective>
Add the per-app exclusion list UI to the settings view — a list of excluded apps with + and – buttons, app icons, and display names, following the macOS System Settings pattern.

Purpose: Gives users the ability to manage which apps are excluded from scroll mode directly from the settings window.
Output: Complete exclusion list management UI in the settings view.
</objective>

<execution_context>
@/Users/blake/.claude/get-shit-done/workflows/execute-plan.md
@/Users/blake/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-per-app-exclusion/12-CONTEXT.md
@.planning/phases/12-per-app-exclusion/12-01-SUMMARY.md
@ScrollMyMac/Features/Settings/SettingsView.swift
@ScrollMyMac/App/AppState.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add exclusion list section to SettingsView</name>
  <files>
    ScrollMyMac/Features/Settings/SettingsView.swift
  </files>
  <action>
Add a new section at the bottom of `MainSettingsView`'s Form (after the "Reset" section, as the last section). Per user decision: "List placed at the bottom of the settings view — last section."

**Section: "Excluded Apps"**

Structure (per locked decisions):
- Section header: "Excluded Apps"
- Help text below the list: "Apps where scroll mode is automatically bypassed. Scroll mode stays on but clicks pass through normally."

**List content:**
- If `appState.excludedAppBundleIDs` is empty, show `Text("No excluded apps")` styled with `.foregroundStyle(.secondary)`.
- If not empty, show each excluded app as a row with:
  - App icon (use `NSWorkspace.shared.icon(forFile:)` via the app's URL resolved from bundle ID, or use a fallback generic app icon `NSWorkspace.shared.icon(for: .applicationBundle)` if the app can't be found).
  - App display name (resolve from bundle ID using `NSRunningApplication.runningApplications(withBundleIdentifier:).first?.localizedName` or fall back to reading the app bundle's `CFBundleDisplayName`/`CFBundleName` from its Info.plist, or fall back to the bundle ID itself if nothing works).
  - Use `Image(nsImage:)` for the icon, sized to about 20x20.
  - The row should be selectable (track `@State private var selectedExcludedApp: String?` for the selected bundle ID).

**To resolve bundle ID to app path:** Use `NSWorkspace.shared.urlForApplication(withBundleIdentifier:)`. This returns the URL to the .app bundle. From there:
- Icon: `NSWorkspace.shared.icon(forFile: url.path)`
- Name: `Bundle(url: url)?.object(forInfoDictionaryKey: "CFBundleDisplayName") as? String ?? Bundle(url: url)?.object(forInfoDictionaryKey: "CFBundleName") as? String ?? bundleID`

**+/– buttons below the list:**
- Use an HStack at the bottom of the section:
  - `Button` with `Image(systemName: "plus")` — opens NSOpenPanel.
  - `Button` with `Image(systemName: "minus")` — removes the selected app. Disabled when `selectedExcludedApp` is nil.
  - Style buttons small/borderless to match macOS System Settings pattern.

**+ button action (NSOpenPanel):**
- Create an `NSOpenPanel` configured with:
  - `allowedContentTypes = [.application]` (UTType.application)
  - `canChooseFiles = true`
  - `canChooseDirectories = false`
  - `allowsMultipleSelection = false`
  - `directoryURL = URL(fileURLWithPath: "/Applications")`
  - `message = "Select an app to exclude from scroll mode"`
- Run modal (`panel.runModal()`). On `.OK`:
  - Get the selected URL.
  - Read the bundle ID from `Bundle(url: selectedURL)?.bundleIdentifier`.
  - If bundle ID exists, call `appState.addExcludedApp(bundleID: bundleID)`.
  - Duplicates are silently ignored (handled by AppExclusionManager).

**– button action:**
- If `selectedExcludedApp` is not nil, call `appState.removeExcludedApp(bundleID: selectedExcludedApp!)`.
- Clear `selectedExcludedApp` after removal.

**List grows with content:** Do NOT put the list in a ScrollView or give it a fixed height. Use a `ForEach` over the bundle IDs directly in the Form section so it grows naturally with the form.

**Import:** Add `import UniformTypeIdentifiers` at the top of the file for `UTType.application`.

Increase the `minHeight` of the frame from 300 to 400 to accommodate the exclusion list section.
  </action>
  <verify>
Project builds successfully with `xcodebuild -project ScrollMyMac.xcodeproj -scheme ScrollMyMac build 2>&1 | tail -5`.
  </verify>
  <done>
Exclusion list section appears at the bottom of the settings view with + and – buttons. Plus opens an NSOpenPanel filtered to .app bundles. Minus removes the selected app. Empty state shows "No excluded apps". Each row shows app icon and display name.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify per-app exclusion end-to-end</name>
  <what-built>Complete per-app exclusion feature: exclusion list management in Settings, automatic scroll mode bypass for excluded apps, and menu bar visual feedback.</what-built>
  <how-to-verify>
1. Launch the app and open Settings
2. Scroll to the bottom — verify "Excluded Apps" section appears with "No excluded apps" placeholder
3. Click the + button — verify an Open dialog appears starting in /Applications, filtered to .app bundles
4. Select an app (e.g., Safari or TextEdit) and click Open — verify it appears in the list with its icon and name
5. Try adding the same app again — verify no duplicate appears
6. Enable scroll mode (F6 or toggle)
7. Switch to the excluded app — verify:
   - Clicks work normally (no scroll interception)
   - Menu bar icon shows a slash through it
   - Menu bar tooltip shows "Scroll mode paused — [App Name] is excluded"
8. Switch back to a non-excluded app — verify:
   - Scroll mode works normally again
   - Menu bar icon returns to normal (no slash)
   - Menu bar tooltip is cleared
9. In Settings, select the excluded app and click the – button — verify it is removed
10. Switch to that app again — verify scroll mode is now active (no longer excluded)
11. Quit and relaunch the app — verify previously added exclusions persist
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. Project compiles cleanly with no errors
2. Exclusion list UI renders in Settings with + and – buttons
3. NSOpenPanel opens filtered to .app bundles
4. Adding an app shows icon + name in the list
5. Removing an app clears it from the list
6. End-to-end: excluded app bypasses scroll mode, menu bar shows slash, switching back restores scroll mode
7. Exclusion list persists across app restarts
</verification>

<success_criteria>
- User can add apps via + button / NSOpenPanel
- User can remove apps via – button
- List shows app icon + display name per row
- Empty state shows "No excluded apps"
- Duplicates silently ignored
- Full exclusion bypass works with menu bar feedback
- Settings persist across restarts
</success_criteria>

<output>
After completion, create `.planning/phases/12-per-app-exclusion/12-02-SUMMARY.md`
</output>
