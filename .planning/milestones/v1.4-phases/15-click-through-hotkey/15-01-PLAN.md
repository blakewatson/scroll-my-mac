---
phase: 15-click-through-hotkey
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ScrollMyMac/App/AppState.swift
  - ScrollMyMac/Features/Settings/SettingsView.swift
autonomous: true
requirements:
  - CTHK-01
  - CTHK-02
  - CTHK-03

must_haves:
  truths:
    - "User can assign a hotkey for click-through toggle in settings using the same key recorder UI as scroll mode hotkey"
    - "Pressing the click-through hotkey toggles click-through mode on/off"
    - "Click-through toggle via hotkey persists to UserDefaults (same as changing it in settings)"
    - "Click-through hotkey is independent of scroll mode hotkey (separate key code and modifiers)"
    - "Clearing the click-through hotkey (setting to None) disables the hotkey listener"
    - "Reset to defaults clears the click-through hotkey (sets to None / keyCode -1)"
  artifacts:
    - path: "ScrollMyMac/App/AppState.swift"
      provides: "Click-through hotkey manager, key code/modifiers persistence, service wiring"
      contains: "clickThroughHotkeyManager"
    - path: "ScrollMyMac/Features/Settings/SettingsView.swift"
      provides: "Click-through hotkey recorder in Scroll Behavior section"
      contains: "HotkeyRecorderView"
  key_links:
    - from: "ScrollMyMac/App/AppState.swift"
      to: "clickThroughHotkeyManager"
      via: "onToggle callback toggles isClickThroughEnabled"
      pattern: "clickThroughHotkeyManager\\.onToggle"
    - from: "ScrollMyMac/Features/Settings/SettingsView.swift"
      to: "AppState.clickThroughHotkeyKeyCode / clickThroughHotkeyModifiers"
      via: "HotkeyRecorderView bindings"
      pattern: "HotkeyRecorderView.*clickThroughHotkey"
---

<objective>
Add a configurable hotkey for toggling click-through mode on/off without opening settings.

Purpose: Users currently must open the settings window to toggle click-through mode. A hotkey lets them toggle it instantly via keyboard, matching the scroll mode hotkey pattern.

Output: Working click-through hotkey with key recorder in settings, persistent state, and independent HotkeyManager instance.
</objective>

<execution_context>
@/Users/blake/.claude/get-shit-done/workflows/execute-plan.md
@/Users/blake/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@ScrollMyMac/App/AppState.swift
@ScrollMyMac/Services/HotkeyManager.swift
@ScrollMyMac/Features/Settings/HotkeyRecorderView.swift
@ScrollMyMac/Features/Settings/SettingsView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add click-through HotkeyManager and AppState wiring</name>
  <files>ScrollMyMac/App/AppState.swift</files>
  <action>
Add a second HotkeyManager instance and click-through hotkey persistence to AppState:

1. **New properties** (add after `isScrollDirectionInverted`):
   - `clickThroughHotkeyKeyCode: Int` with didSet persisting to UserDefaults key `"clickThroughHotkeyKeyCode"` and calling `applyClickThroughHotkeySettings()`. Default: -1 (no hotkey).
   - `clickThroughHotkeyModifiers: UInt64` with didSet persisting to UserDefaults key `"clickThroughHotkeyModifiers"` (same UInt64-to-Int pattern as `hotkeyModifiers`) and calling `applyClickThroughHotkeySettings()`. Default: 0.

2. **New service** (add after `let appExclusionManager`):
   - `let clickThroughHotkeyManager = HotkeyManager()`

3. **Init**: Load `clickThroughHotkeyKeyCode` from UserDefaults (default -1) and `clickThroughHotkeyModifiers` from UserDefaults (default 0), using the same pattern as the existing hotkey loading.

4. **setupServices()**: Wire `clickThroughHotkeyManager.onToggle` to toggle `isClickThroughEnabled` (not scroll mode). Call `applyClickThroughHotkeySettings()`.

5. **New method `applyClickThroughHotkeySettings()`**: Mirror `applyHotkeySettings()` but for `clickThroughHotkeyManager`. If `clickThroughHotkeyKeyCode >= 0`, set keyCode, requiredModifiers, suppressUntil, and call start(). If keyCode is -1, call stop().

6. **`isAccessibilityGranted` didSet**: Also start/stop `clickThroughHotkeyManager` alongside `hotkeyManager`. When granted, start clickThroughHotkeyManager only if `clickThroughHotkeyKeyCode >= 0`. When revoked, stop it.

7. **resetToDefaults()**: Add `clickThroughHotkeyKeyCode = -1` and `clickThroughHotkeyModifiers = 0`.

Note: `isClickThroughEnabled` already has a didSet that persists to UserDefaults and syncs to ScrollEngine, so toggling it via hotkey automatically persists and takes effect.
  </action>
  <verify>Build with `xcodebuild -project ScrollMyMac.xcodeproj -scheme ScrollMyMac -configuration Debug build 2>&1 | tail -5` — should show BUILD SUCCEEDED.</verify>
  <done>AppState has a second HotkeyManager for click-through, loads/saves key code and modifiers from UserDefaults, wires onToggle to flip isClickThroughEnabled, and starts/stops with accessibility permission.</done>
</task>

<task type="auto">
  <name>Task 2: Add click-through hotkey recorder to Settings UI</name>
  <files>ScrollMyMac/Features/Settings/SettingsView.swift</files>
  <action>
Add a HotkeyRecorderView for the click-through hotkey in the "Scroll Behavior" section of MainSettingsView:

1. In the "Scroll Behavior" section, after the click-through toggle and its help text, add:
   - A `HotkeyRecorderView(keyCode: $appState.clickThroughHotkeyKeyCode, modifiers: $appState.clickThroughHotkeyModifiers)`
   - Help text: `"Assign a hotkey to toggle click-through mode without opening settings. Function keys work alone; other keys need a modifier."` in `.font(.callout).foregroundStyle(.secondary)`

The HotkeyRecorderView component already handles recording, display, and clearing — no changes needed to it. The bindings connect directly to the new AppState properties whose didSets handle persistence and HotkeyManager updates.
  </action>
  <verify>Build with `xcodebuild -project ScrollMyMac.xcodeproj -scheme ScrollMyMac -configuration Debug build 2>&1 | tail -5` — should show BUILD SUCCEEDED.</verify>
  <done>Settings UI shows a hotkey recorder for click-through mode in the Scroll Behavior section, using the same HotkeyRecorderView component as the scroll mode hotkey. User can set, change, or clear the click-through hotkey.</done>
</task>

</tasks>

<verification>
1. Build succeeds with no errors or warnings related to new code.
2. AppState initializes with clickThroughHotkeyKeyCode = -1 (no hotkey by default).
3. Setting a click-through hotkey via the recorder persists to UserDefaults.
4. Pressing the configured click-through hotkey toggles isClickThroughEnabled.
5. The toggle persists across app restarts (UserDefaults already handles this via isClickThroughEnabled didSet).
6. Reset to defaults clears the click-through hotkey.
7. Click-through hotkey and scroll mode hotkey operate independently.
</verification>

<success_criteria>
- User can assign a hotkey for click-through toggle in settings
- Key recorder UI is identical to scroll mode hotkey recorder
- Pressing the hotkey toggles click-through mode on/off
- Toggle persists to UserDefaults
- Clearing the hotkey disables the listener
- Reset to defaults clears the click-through hotkey
</success_criteria>

<output>
After completion, create `.planning/phases/15-click-through-hotkey/15-01-SUMMARY.md`
</output>
