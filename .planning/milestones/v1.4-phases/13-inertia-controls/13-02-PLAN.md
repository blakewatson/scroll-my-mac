---
phase: 13-inertia-controls
plan: 02
type: execute
wave: 2
depends_on: [13-01]
files_modified:
  - ScrollMyMac/Features/Settings/SettingsView.swift
autonomous: false
requirements: [INRT-01, INRT-02]

must_haves:
  truths:
    - "User can see a Momentum scrolling toggle in the settings"
    - "User can see an Intensity slider that is disabled when momentum scrolling is off"
    - "The slider has endpoint labels Less and More (or similar)"
    - "The slider has a visual center tick mark at 50%"
    - "The slider snaps to center when the thumb is near it"
    - "Settings are reorganized into logical groups with the growing number of controls"
    - "Slider changes take effect immediately on the next scroll drag"
  artifacts:
    - path: "ScrollMyMac/Features/Settings/SettingsView.swift"
      provides: "Inertia controls UI and reorganized settings layout"
      contains: "Momentum scrolling"
  key_links:
    - from: "ScrollMyMac/Features/Settings/SettingsView.swift"
      to: "ScrollMyMac/App/AppState.swift"
      via: "$appState.isInertiaEnabled and $appState.inertiaIntensity bindings"
      pattern: "appState\\.isInertiaEnabled|appState\\.inertiaIntensity"
---

<objective>
Add inertia controls UI (toggle + intensity slider with center detent) and reorganize the settings view for clarity.

Purpose: Users need accessible controls to tune or disable momentum scrolling. The settings view also needs reorganization because the growing number of controls makes the current flat layout hard to scan.
Output: SettingsView with reorganized sections, inertia toggle, and intensity slider with center snap.
</objective>

<execution_context>
@/Users/blake/.claude/get-shit-done/workflows/execute-plan.md
@/Users/blake/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-inertia-controls/13-CONTEXT.md
@.planning/phases/13-inertia-controls/13-01-SUMMARY.md
@ScrollMyMac/Features/Settings/SettingsView.swift
@ScrollMyMac/App/AppState.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reorganize SettingsView and add inertia controls with center-detent slider</name>
  <files>ScrollMyMac/Features/Settings/SettingsView.swift</files>
  <action>
Rewrite the `MainSettingsView` body to reorganize sections and add inertia controls. Per user decision, Claude has discretion on grouping -- just make it make sense.

**Recommended section reorganization:**

1. **Permission Warning** (conditional, same as today -- keep at top)
2. **Scroll Mode** -- The main toggle and hotkey
   - Enable Scroll Mode toggle + help text
   - Hotkey recorder + help text
3. **Scroll Behavior** -- How scrolling feels
   - Click-through toggle + help text
   - Click-and-hold passthrough toggle + help text
   - Hold delay stepper (disabled when passthrough off)
   - Momentum scrolling toggle (new -- binds to `$appState.isInertiaEnabled`)
   - Intensity slider (new -- binds to `$appState.inertiaIntensity`, disabled when momentum off)
4. **Safety** -- Same as today
   - Safety timeout toggle + help text
5. **General** -- App-wide settings
   - Show menu bar icon toggle + help text
   - Launch at login toggle + help text
6. **Excluded Apps** -- Same as today (keep at bottom, it's the largest section)
7. **Reset** -- Same as today

**Inertia toggle implementation:**
```swift
Toggle("Momentum scrolling", isOn: $appState.isInertiaEnabled)
Text("When enabled, releasing a drag produces continued scrolling with gradual deceleration.")
    .font(.callout)
    .foregroundStyle(.secondary)
```

**Intensity slider implementation with center detent:**

Create the slider with endpoint labels and a center tick mark overlay:

```swift
VStack(alignment: .leading, spacing: 4) {
    Text("Intensity")
    HStack {
        Text("Less")
            .font(.caption)
            .foregroundStyle(.secondary)
        Slider(value: $appState.inertiaIntensity, in: 0...1)
            .onChange(of: appState.inertiaIntensity) { _, newValue in
                // Snap to center: if within 0.05 of 0.5, snap to exactly 0.5
                if abs(newValue - 0.5) < 0.05 && newValue != 0.5 {
                    appState.inertiaIntensity = 0.5
                }
            }
            .overlay(
                // Center tick mark
                GeometryReader { geometry in
                    Rectangle()
                        .fill(Color.secondary.opacity(0.4))
                        .frame(width: 1, height: 8)
                        .position(x: geometry.size.width / 2, y: geometry.size.height / 2)
                }
                .allowsHitTesting(false)
            )
        Text("More")
            .font(.caption)
            .foregroundStyle(.secondary)
    }
}
.disabled(!appState.isInertiaEnabled)
```

The `.disabled(!appState.isInertiaEnabled)` grays out the slider when inertia is toggled off (per user decision -- slider disabled, not hidden). The toggle off/on remembers the previous slider position because `inertiaIntensity` is stored separately and not reset when toggling.

**Move existing sections:**
- Move Hotkey section contents into "Scroll Mode" section (the hotkey IS scroll mode activation)
- Move click-through and hold-to-passthrough into "Scroll Behavior" (they modify scroll behavior)
- Keep Safety and General sections as-is
- Keep Excluded Apps and Reset at the bottom

Preserve ALL existing functionality -- this is a layout reorganization plus new controls, not a rewrite of existing logic. All onChange handlers, helper methods, state variables remain unchanged.
  </action>
  <verify>Build: `xcodebuild -project ScrollMyMac.xcodeproj -scheme ScrollMyMac -configuration Debug build 2>&1 | tail -5`. Grep for new UI elements: `grep -n "Momentum scrolling\|Intensity\|inertiaEnabled\|inertiaIntensity" ScrollMyMac/Features/Settings/SettingsView.swift`.</verify>
  <done>Settings view is reorganized into logical sections. Momentum scrolling toggle and Intensity slider with center detent are present and bound to AppState. Slider is disabled when momentum is off. All existing settings functionality preserved.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify inertia controls in the running app</name>
  <action>Human verification of the inertia controls UI and behavior.</action>
  <what-built>Inertia on/off toggle and intensity slider with center-detent snap, plus reorganized settings layout</what-built>
  <how-to-verify>
1. Build and run the app (Cmd+R in Xcode or `xcodebuild ... && open ...`)
2. Open the Settings window

**Settings layout verification:**
3. Confirm settings are organized into clear sections: Scroll Mode (with hotkey), Scroll Behavior (with click-through, hold-passthrough, momentum, intensity), Safety, General, Excluded Apps, Reset
4. Confirm all existing settings are still present and functional

**Inertia toggle verification:**
5. Find the "Momentum scrolling" toggle in the Scroll Behavior section -- confirm it defaults to ON
6. Toggle it OFF -- confirm the Intensity slider becomes grayed out / disabled
7. Toggle it back ON -- confirm the slider returns to its previous position
8. With scroll mode active (F6), drag to scroll and release -- confirm inertia coasts as before

**Inertia disable verification:**
9. Toggle "Momentum scrolling" OFF
10. Drag to scroll and release -- confirm scrolling stops IMMEDIATELY with no coasting

**Intensity slider verification:**
11. Toggle "Momentum scrolling" back ON
12. Drag the Intensity slider to the left (toward "Less") -- scroll and release -- confirm coasting is shorter/slower
13. Drag the slider to the right (toward "More") -- scroll and release -- confirm coasting is longer/faster
14. Drag the slider near the center -- confirm it snaps to the center position (50%)
15. Confirm there is a visible tick mark at the center of the slider

**Persistence verification:**
16. Quit and relaunch the app -- confirm inertia toggle state and slider position are preserved
17. Click "Reset to Defaults" -- confirm inertia toggle returns to ON and slider returns to center
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. `xcodebuild -project ScrollMyMac.xcodeproj -scheme ScrollMyMac -configuration Debug build` completes with zero errors
2. Settings window shows reorganized sections with logical grouping
3. Momentum scrolling toggle is present and defaults to on
4. Intensity slider is present with "Less"/"More" labels and center tick mark
5. Slider snaps to center when thumb is near 50%
6. Slider is disabled (grayed out) when momentum scrolling is off
7. Toggling momentum off stops all coasting on drag release
8. Toggling momentum back on restores coasting at the last-used intensity
9. Slider position affects coasting feel (less = shorter, more = longer)
10. Both settings persist across app restart
11. Reset to Defaults restores toggle=on, slider=center
</verification>

<success_criteria>
- Settings are reorganized into clear, logical sections
- Momentum scrolling toggle controls inertia on/off
- Intensity slider with center detent controls coasting intensity
- Slider is disabled when momentum scrolling is off
- All settings changes take effect immediately
- User verification confirms expected behavior
</success_criteria>

<output>
After completion, create `.planning/phases/13-inertia-controls/13-02-SUMMARY.md`
</output>
