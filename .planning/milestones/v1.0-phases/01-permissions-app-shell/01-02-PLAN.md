---
phase: 01-permissions-app-shell
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - ScrollMyMac/Features/Settings/SettingsView.swift
  - ScrollMyMac/Services/SafetyTimeoutManager.swift
autonomous: false

must_haves:
  truths:
    - "Main window shows an on/off toggle for scroll mode as a regular settings row"
    - "Settings include a safety timeout toggle that is on by default"
    - "Safety timeout auto-deactivates scroll mode after 10 seconds of no mouse movement"
    - "Brief notification is shown when safety timeout triggers"
    - "Safety mode setting persists across app restarts"
  artifacts:
    - path: "ScrollMyMac/Features/Settings/SettingsView.swift"
      provides: "Full settings form with scroll mode toggle, safety mode toggle"
      contains: "Safety timeout"
    - path: "ScrollMyMac/Services/SafetyTimeoutManager.swift"
      provides: "10-second no-movement auto-deactivation with notification"
      contains: "timeoutInterval"
  key_links:
    - from: "ScrollMyMac/Features/Settings/SettingsView.swift"
      to: "ScrollMyMac/App/AppState.swift"
      via: "Environment injection of AppState"
      pattern: "Environment.*AppState"
    - from: "ScrollMyMac/Services/SafetyTimeoutManager.swift"
      to: "ScrollMyMac/App/AppState.swift"
      via: "Callback to deactivate scroll mode on timeout"
      pattern: "isScrollModeActive"
---

<objective>
Build the full settings UI and safety timeout mechanism. The settings window becomes the user-facing control panel with scroll mode toggle and safety controls.

Purpose: Complete the Phase 1 user experience -- a settings window with all controls and the safety timeout safeguard.
Output: Polished settings view and working safety timeout manager.
</objective>

<execution_context>
@/Users/blakewatson/.claude/get-shit-done/workflows/execute-plan.md
@/Users/blakewatson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-permissions-app-shell/01-RESEARCH.md
@.planning/phases/01-permissions-app-shell/01-CONTEXT.md
@.planning/phases/01-permissions-app-shell/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement SafetyTimeoutManager and full settings view</name>
  <files>
    ScrollMyMac/Services/SafetyTimeoutManager.swift
    ScrollMyMac/Features/Settings/SettingsView.swift
  </files>
  <action>
**SafetyTimeoutManager.swift** -- 10-second no-movement auto-deactivation:
- `@Observable class SafetyTimeoutManager`
- Properties:
  - `private var checkTimer: Timer?`
  - `private var lastMousePosition: CGPoint = .zero`
  - `private var lastMovementTime: Date = Date()`
  - `private let timeoutInterval: TimeInterval = 10.0` (user-specified 10 seconds)
  - `private let checkInterval: TimeInterval = 0.5` (poll every 0.5s)
  - `var onSafetyTimeout: (() -> Void)?` -- callback when timeout triggers
- `func startMonitoring()`:
  - Record current `NSEvent.mouseLocation` as `lastMousePosition`
  - Set `lastMovementTime = Date()`
  - Start `checkTimer` at 0.5s interval calling `checkMouseMovement()`
- `func stopMonitoring()`:
  - Invalidate and nil out `checkTimer`
- `private func checkMouseMovement()`:
  - Get current `NSEvent.mouseLocation`
  - If position changed from `lastMousePosition`: update position and reset `lastMovementTime`
  - If position unchanged AND `Date().timeIntervalSince(lastMovementTime) >= timeoutInterval`: call `onSafetyTimeout?()` then `stopMonitoring()`
- `func resetTimer()` -- call when scroll mode is toggled on to reset the countdown
  - Sets `lastMovementTime = Date()` and `lastMousePosition = NSEvent.mouseLocation`

**SettingsView.swift** -- replace the placeholder settings content with full form:
- Receives `AppState` from environment
- Create `@State private var safetyTimeoutManager = SafetyTimeoutManager()`
- Use `Form` with `.formStyle(.grouped)` for native macOS grouped settings appearance
- Sections:

  **Section("Scroll Mode")**:
  - `Toggle("Enable Scroll Mode", isOn: Bindable(appState).isScrollModeActive)`
  - Add `.disabled(true)` -- toggle exists but is not functional until Phase 2
  - Add helper text below: "Toggle will be activated in a future update." (or similar subtle note)

  **Section("Safety")**:
  - `Toggle("Safety timeout", isOn: Bindable(appState).isSafetyModeEnabled)`
  - Description text below the toggle: "Automatically deactivates scroll mode after 10 seconds of no mouse movement."

- Frame: `.frame(minWidth: 450, idealWidth: 450, minHeight: 250)`
- Window title via `.navigationTitle("Scroll My Mac")`

**Wiring SafetyTimeoutManager to AppState:**
- In SettingsView `.onAppear` or `.onChange(of: appState.isScrollModeActive)`:
  - When `isScrollModeActive` becomes true AND `isSafetyModeEnabled` is true: call `safetyTimeoutManager.startMonitoring()`
  - When `isScrollModeActive` becomes false: call `safetyTimeoutManager.stopMonitoring()`
- Set `safetyTimeoutManager.onSafetyTimeout` to a closure that:
  1. Sets `appState.isScrollModeActive = false`
  2. Shows a brief notification. Use a simple approach: set a `@State var showSafetyAlert = false` and display a temporary overlay or use `NSApp.requestUserAttention(.informationalRequest)` plus a brief text overlay. The simplest approach: show a transient text label "Scroll mode deactivated (safety timeout)" that auto-dismisses after 3 seconds using a `Task { try await Task.sleep(for: .seconds(3)); showNotification = false }` pattern.
- Also observe `isSafetyModeEnabled` changes: if safety mode is turned off while scroll mode is active, stop monitoring. If turned on while scroll mode is active, start monitoring.

**Important per user decisions:**
- Toggle is a regular settings row, not prominently placed (it is just one item in the Scroll Mode section)
- Safety mode is on by default (ensured by AppState defaulting `isSafetyModeEnabled = true`)
- Permission status is NOT shown in settings (only in the setup flow from Plan 01)
  </action>
  <verify>
Build the project. Launch the app (with Accessibility permission already granted from Plan 01 testing). Verify: settings form shows with "Scroll Mode" section (toggle disabled) and "Safety" section (toggle enabled by default). Verify safety mode toggle state persists after quitting and relaunching. Verify the settings window has proper macOS native styling.
  </verify>
  <done>
Full settings form with scroll mode toggle (disabled, ready for Phase 2) and safety timeout toggle (enabled by default, persisted). SafetyTimeoutManager monitors mouse position every 0.5s and deactivates scroll mode after 10s of no movement with a brief notification. Safety mode wiring responds to scroll mode and safety mode state changes.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete Phase 1 app experience</name>
  <files>N/A -- verification only</files>
  <action>
Human verification of the complete Phase 1 app experience. What was built: Xcode project, app shell with window lifecycle, permission detection and onboarding flow, settings UI with scroll mode toggle and safety timeout, and SafetyTimeoutManager.
  </action>
  <verify>
1. Build and run the app (Cmd+R in Xcode or `xcodebuild`)
2. **First launch (no permission):** App should show the permission setup view with icon, explanation, numbered steps, and "Grant Permission" button
3. **Grant permission:** Click "Grant Permission", follow the system prompt, enable in System Settings. The app should detect the grant within ~2 seconds and transition to the settings view
4. **Settings view:** Verify you see a "Scroll Mode" section with a disabled toggle and a "Safety" section with an enabled toggle
5. **Close window:** Press Cmd+W -- window disappears but app stays in Dock
6. **Reopen:** Click Dock icon -- settings window reappears
7. **Relaunch:** Quit and relaunch -- app should go directly to settings (not permission setup)
8. **Safety toggle persistence:** Toggle safety mode off, quit, relaunch -- should still be off
9. **No duplicate windows:** Press Cmd+N -- nothing should happen
10. **Native styling:** Window should use standard macOS chrome, system fonts, default SwiftUI controls
  </verify>
  <done>User types "approved" or describes issues to fix. All 10 verification steps pass.</done>
</task>

</tasks>

<verification>
1. Settings form displays with grouped style and correct sections
2. Scroll mode toggle is present but disabled (not functional until Phase 2)
3. Safety timeout toggle defaults to on and persists across app restarts
4. SafetyTimeoutManager starts/stops monitoring based on scroll mode and safety mode state
5. Safety timeout notification appears when triggered (can be tested by temporarily setting timeout to 2s)
6. Window title shows "Scroll My Mac"
7. All Phase 1 success criteria from roadmap are met
</verification>

<success_criteria>
- Settings form with scroll mode toggle (disabled) and safety timeout toggle (enabled, persisted)
- SafetyTimeoutManager monitors mouse position at 0.5s intervals, triggers after 10s of no movement
- Safety deactivation shows brief notification
- Human verification confirms complete Phase 1 experience works end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/01-permissions-app-shell/01-02-SUMMARY.md`
</output>
