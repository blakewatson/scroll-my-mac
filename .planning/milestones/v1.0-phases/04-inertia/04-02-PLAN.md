---
phase: 04-inertia
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - ScrollMyMac/App/AppState.swift
  - ScrollMyMac/Features/Settings/SettingsView.swift
autonomous: false

must_haves:
  truths:
    - "User can toggle between axis-lock and free-scroll modes in settings"
    - "Axis lock setting persists across app restarts"
    - "Axis lock is the default; free-scroll is opt-in"
    - "Changing the setting takes effect on the next drag"
  artifacts:
    - path: "ScrollMyMac/App/AppState.swift"
      provides: "isAxisLockEnabled property with UserDefaults persistence"
      contains: "isAxisLockEnabled"
    - path: "ScrollMyMac/Features/Settings/SettingsView.swift"
      provides: "Toggle for axis lock setting in UI"
      contains: "Axis lock"
  key_links:
    - from: "ScrollMyMac/App/AppState.swift"
      to: "ScrollMyMac/Services/ScrollEngine.swift"
      via: "isAxisLockEnabled didSet syncs to scrollEngine.useAxisLock"
      pattern: "scrollEngine\\.useAxisLock"
---

<objective>
Add axis-lock vs free-scroll settings toggle and verify the complete inertia system with user testing.

Purpose: The user requested a settings toggle for axis lock (default on) vs free-scroll mode. This plan also provides a human verification checkpoint to confirm the entire inertia system feels right.
Output: Updated AppState.swift with persisted axis lock setting, updated SettingsView.swift with toggle, user-verified inertia behavior.
</objective>

<execution_context>
@/Users/blakewatson/.claude/get-shit-done/workflows/execute-plan.md
@/Users/blakewatson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-inertia/04-CONTEXT.md
@.planning/phases/04-inertia/04-01-SUMMARY.md
@ScrollMyMac/App/AppState.swift
@ScrollMyMac/Features/Settings/SettingsView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add axis-lock settings toggle</name>
  <files>ScrollMyMac/App/AppState.swift, ScrollMyMac/Features/Settings/SettingsView.swift</files>
  <action>
**AppState.swift:**

1. Add a new persisted property following the same pattern as `isClickThroughEnabled`:
```swift
var isAxisLockEnabled: Bool {
    didSet {
        UserDefaults.standard.set(isAxisLockEnabled, forKey: "axisLockEnabled")
        scrollEngine.useAxisLock = isAxisLockEnabled
    }
}
```

2. In `init()`, load from UserDefaults with `true` as default (axis lock is default per user decision):
```swift
self.isAxisLockEnabled = UserDefaults.standard.object(forKey: "axisLockEnabled") as? Bool ?? true
```

3. In `setupServices()`, add initial sync: `scrollEngine.useAxisLock = isAxisLockEnabled`

**SettingsView.swift (MainSettingsView):**

4. In the "Scroll Mode" section, after the click-through toggle and its caption, add:
```swift
Toggle("Axis lock", isOn: $appState.isAxisLockEnabled)
Text("When enabled, scrolling locks to the dominant direction (vertical or horizontal). When disabled, scrolling moves freely in both directions.")
    .font(.caption)
    .foregroundStyle(.secondary)
```
  </action>
  <verify>
Build: `xcodebuild -project ScrollMyMac.xcodeproj -scheme ScrollMyMac -configuration Debug build 2>&1 | tail -20`. Must compile clean. Verify by reading AppState.swift that `isAxisLockEnabled` has didSet with UserDefaults persistence and scrollEngine sync. Verify SettingsView.swift has the toggle.
  </verify>
  <done>Axis lock toggle appears in Settings under Scroll Mode section. Default is on (axis lock). Setting persists via UserDefaults. Changing toggle syncs to scrollEngine.useAxisLock immediately.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify inertia behavior</name>
  <what-built>
Complete inertia/momentum scrolling system with:
- Velocity tracking during drag (80ms sample window)
- Exponential decay momentum on release (tau=0.400s)
- CADisplayLink frame synchronization
- Click-during-inertia consumes click and stops
- F6 during inertia stops immediately
- Axis lock toggle in Settings (default: on)
- Momentum scroll phase events (begin/continue/end)
  </what-built>
  <how-to-verify>
1. Build and run the app. Grant accessibility permission if needed. Press F6 to enable scroll mode.

2. **Basic inertia:** In a long scrollable page (e.g., Safari on a Wikipedia article), click-drag quickly downward then release. Content should continue scrolling with gradual deceleration, slowing to a smooth stop. Faster drags should coast further.

3. **No micro-coasting:** Drag very slowly, then release. There should be no visible momentum — scrolling stops on release.

4. **Pause detection:** Drag fast, then hold still for ~0.5s, then release. No inertia should occur (the pause cleared velocity).

5. **Click to stop inertia:** Do a fast drag to trigger inertia, then click while content is still coasting. Scrolling should stop instantly. The click should NOT activate anything underneath (consumed).

6. **F6 during inertia:** Trigger inertia, then press F6. Inertia stops immediately and scroll mode turns off.

7. **Axis lock:** With "Axis lock" on (default) in Settings, drag diagonally. Scrolling should lock to one axis. Inertia should continue in that same locked direction.

8. **Free scroll:** Turn off "Axis lock" in Settings. Drag diagonally. Both axes should scroll simultaneously, and inertia should coast diagonally.

9. **Smoothness:** Inertia should feel smooth — no stuttering, jumping, or visible frame drops. The deceleration curve should feel natural (fast at first, gradually slowing).

10. **Axis lock persists:** Quit and relaunch. The axis lock setting should be preserved.
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 4, or describe any issues with the feel, behavior, or smoothness.</resume-signal>
</task>

</tasks>

<verification>
1. Build succeeds with axis lock toggle
2. Settings UI shows axis lock toggle with correct default (on)
3. User confirms: inertia feels natural, interruptions work, axis lock works
</verification>

<success_criteria>
- Axis lock toggle visible in Settings, defaults to on, persists across restarts
- User approves inertia feel: deceleration curve, coast distance, smoothness
- User approves interruption behavior: click-stops, F6-stops, new-drag-takes-over
- User approves axis lock: locks during drag and inertia, free-scroll works when disabled
</success_criteria>

<output>
After completion, create `.planning/phases/04-inertia/04-02-SUMMARY.md`
</output>
